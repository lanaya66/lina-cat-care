# 📊 历史数据修复指南

## 🎯 为什么需要修复？

之前的计算逻辑存在问题，导致：
- ❌ 食物摄入量偏少
- ❌ 水摄入量偏多

新的计算逻辑更准确地区分了"食物本身"和"额外加水"，能正确反映实际摄入情况。

---

## 🔧 修复步骤（3步完成）

### 第 1 步：执行数据库迁移

1. 打开 Supabase 项目：https://supabase.com
2. 点击你的项目
3. 左侧点击 **🗄️ SQL Editor**
4. 点击 **+ New query**
5. 复制粘贴以下 SQL：

```sql
-- 添加新字段
ALTER TABLE food_cards 
ADD COLUMN IF NOT EXISTS current_food_weight NUMERIC;

ALTER TABLE food_cards 
ADD COLUMN IF NOT EXISTS current_added_water NUMERIC;

-- 初始化现有数据
UPDATE food_cards 
SET 
  current_food_weight = initial_weight,
  current_added_water = initial_water_added
WHERE current_food_weight IS NULL OR current_added_water IS NULL;
```

6. 点击右下角 **Run** 按钮
7. 看到 "Success" 表示成功

---

### 第 2 步：自动修复历史数据

1. **刷新浏览器** http://localhost:3001
2. 进入 **"今日统计"** 页面
3. 看到右下角有个 **紫色圆形按钮**，写着 **"修复历史数据"**
4. 点击按钮
5. 确认对话框（会提示：此操作不可撤销）
6. 等待修复完成（会显示进度）
7. 修复完成后，点击 **"刷新页面"**

**修复按钮位置：**
```
┌────────────────────────┐
│  今日统计页面           │
│                        │
│  [食物摄入] [水摄入]    │
│                        │
│         ↓              │
│    [查看时间线]         │
│                        │
└────────────────────────┘
              🔄 修复历史数据 ← 紫色按钮在这里
```

---

### 第 3 步：验证修复结果

修复完成后，检查以下内容：

#### ✅ 查看今日统计
- 食物摄入量应该**增加**
- 水摄入量应该**减少**
- 数值更接近实际情况

#### ✅ 查看时间线
- 每条"记录吃剩的"或"结算"记录
- 点击查看详情，应该能看到更详细的分解

#### ✅ 查看趋势图
- 趋势曲线应该更平滑
- 食物和水的比例更合理

---

## 📋 修复原理

### 旧逻辑（错误）
```
消耗量 = 上次剩余 - 本次剩余
食物摄入 = 消耗量 × (1 - 水分比例)  ❌ 错误
水摄入 = 消耗量 × 水分比例          ❌ 错误
```

**问题**：没有区分食物本身的水分和额外加的水。

---

### 新逻辑（正确）
```
消耗量 = 上次剩余 - 本次剩余

按比例分配消耗：
  食物消耗 = 消耗量 × (食物重量 / 总剩余)  ✅
  额外水消耗 = 消耗量 × (额外水 / 总剩余)  ✅

计算实际摄入：
  食物中的水 = 食物消耗 × 食物含水比     ✅
  纯食物 = 食物消耗 × (1 - 食物含水比)   ✅
  总水摄入 = 食物中的水 + 额外水消耗     ✅
```

**优点**：
- 正确区分食物和水
- 符合物理实际
- 数据更准确

---

## 🧪 测试案例

### 示例数据
```
备餐：100g 罐头（78%含水）+ 20g 水
  总剩余：120g

记录剩余：60g
  消耗：60g
```

### 旧逻辑结果（错误）
```
水分比例 = (100×0.78 + 20) / 120 = 81.67%
食物摄入 = 60 × (1 - 0.8167) = 11g    ❌ 太少！
水摄入 = 60 × 0.8167 = 49g            ❌ 太多！
```

### 新逻辑结果（正确）
```
食物消耗 = 60 × (100/120) = 50g
额外水消耗 = 60 × (20/120) = 10g

食物中的水 = 50 × 0.78 = 39g
纯食物 = 50 × 0.22 = 11g
总水摄入 = 39 + 10 = 49g

✅ 食物摄入（含水）：50g
✅ 纯食物摄入：11g
✅ 总水摄入：49g
```

---

## ⚠️ 注意事项

### 修复前
- ✅ 确保已执行数据库 SQL
- ✅ 确保已登录
- ✅ 备份重要数据（可选）

### 修复过程中
- ⏱️ 修复可能需要几秒到几分钟（取决于数据量）
- 🚫 不要关闭浏览器
- 🚫 不要刷新页面

### 修复后
- ✅ 必须刷新页面才能看到新数据
- ✅ 新添加的数据会自动使用新逻辑
- ✅ 旧数据已全部更新

---

## 🤔 常见问题

### Q: 修复会删除数据吗？
A: 不会！只是重新计算摄入量，不会删除任何记录。

### Q: 可以多次修复吗？
A: 可以，但没必要。修复是幂等的，多次执行结果相同。

### Q: 修复失败怎么办？
A: 
1. 查看浏览器控制台错误信息
2. 确认 SQL 已正确执行
3. 确认网络连接正常
4. 重新尝试

### Q: 修复后数据还是不对？
A: 
1. 确认已刷新页面
2. 清除浏览器缓存
3. 检查时间线记录是否完整

---

## 📞 需要帮助？

如果遇到问题：
1. 查看浏览器控制台（F12）的错误信息
2. 查看 `UPDATE_NOTES.md` 了解更多技术细节
3. 检查 Supabase 数据库是否正常

---

**修复完成后，你将看到更准确的摄入量数据！** 🎉

